# Jacla Portal アーキテクチャ概要

> このドキュメントは、Jacla Portal のシステムアーキテクチャを説明するためのものです。

---

## 1. 技術スタック

```mermaid
graph TB
    subgraph Frontend["フロントエンド"]
        Next["Next.js 16 (App Router)"]
        React["React 19"]
        TS["TypeScript 5"]
        Tailwind["Tailwind CSS 4"]
    end

    subgraph Backend["バックエンド / BaaS"]
        Supabase["Supabase"]
        PostgreSQL["PostgreSQL"]
        Auth["Supabase Auth (Google OAuth)"]
        Storage["Supabase Storage"]
    end

    subgraph Hosting["ホスティング"]
        Vercel["Vercel"]
    end

    Frontend --> Backend
    Next --> Vercel
```

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| **フレームワーク** | Next.js (App Router) | 16.0.7 |
| **UI ライブラリ** | React | 19.2.0 |
| **言語** | TypeScript | 5.x |
| **スタイリング** | Tailwind CSS | 4.x |
| **DB / BaaS** | Supabase (PostgreSQL) | 最新 |
| **認証** | Supabase Auth (Google OAuth) | - |
| **ホスティング** | Vercel | - |
| **状態管理** | TanStack Query | 5.90.16 |
| **UI コンポーネント** | Radix UI | 最新 |

---

## 2. ディレクトリ構造

```
jacla-portal/
├── app/                    # Next.js App Router ページ
│   ├── admin/              # 管理者向けページ
│   ├── api/                # API Routes
│   ├── auth/               # 認証関連
│   ├── bands/              # バンド管理
│   ├── events/             # イベント管理
│   ├── lighting/           # 照明指示書
│   ├── pa/                 # PA指示書
│   ├── me/                 # マイページ
│   ├── members/            # 部員一覧
│   ├── onboarding/         # 初回登録
│   ├── maintenance/        # 備品管理
│   └── ...
├── components/             # 共通UIコンポーネント
│   ├── ui/                 # 基本UIパーツ (Button, Card, Dialog等)
│   ├── instructions/       # PA/照明指示書コンポーネント
│   └── ...
├── lib/                    # ユーティリティ・フック
│   ├── supabaseClient.tsx  # Supabase クライアント
│   ├── AuthGuard.tsx       # 認証ガード
│   ├── useIsAdmin.ts       # 管理者判定フック
│   └── ...
├── contexts/               # React Context
│   └── AuthContext.tsx     # 認証コンテキスト
├── public/                 # 静的ファイル
├── tools/                  # 外部ツール (AI等)
└── 仕様書/                  # ドキュメント
```

---

## 3. アプリケーションアーキテクチャ

```mermaid
graph TD
    subgraph Client["クライアント (ブラウザ)"]
        Browser["ブラウザ"]
    end

    subgraph NextJS["Next.js App Router"]
        Layout["RootLayout"]
        AuthProvider["AuthProvider"]
        AuthGuard["AuthGuard"]
        Pages["ページコンポーネント"]
        API["API Routes"]
    end

    subgraph Supabase["Supabase"]
        Auth["Auth (Google OAuth)"]
        DB["PostgreSQL"]
        Storage["Storage"]
    end

    Browser --> Layout
    Layout --> AuthProvider
    AuthProvider --> AuthGuard
    AuthGuard --> Pages
    Pages --> API
    API --> DB
    AuthProvider --> Auth
    Pages --> Storage
```

### 3.1 レイヤー構成

1. **プレゼンテーション層** (`app/`, `components/`)
   - Next.js App Router によるファイルベースルーティング
   - Server Components と Client Components の使い分け
   - Radix UI ベースの共通 UI コンポーネント

2. **ビジネスロジック層** (`lib/`)
   - 認証・認可ロジック (`AuthGuard.tsx`)
   - ロール判定フック (`useIsAdmin.ts`, `useRoleFlags.ts`)
   - ユーティリティ関数

3. **データアクセス層** (`lib/supabaseClient.tsx`, `app/api/`)
   - Supabase クライアントによる直接 DB アクセス
   - API Routes による外部連携

4. **状態管理層** (`contexts/`, TanStack Query)
   - 認証状態 (`AuthContext`)
   - サーバー状態キャッシュ (TanStack Query)

---

## 4. 認証・認可フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant Browser as ブラウザ
    participant AuthGuard as AuthGuard
    participant Supabase as Supabase Auth
    participant DB as PostgreSQL

    User->>Browser: アクセス
    Browser->>AuthGuard: ページ読み込み
    AuthGuard->>Supabase: セッション確認
    
    alt 未認証
        AuthGuard->>Browser: /login へリダイレクト
        User->>Supabase: Googleログイン
        Supabase->>AuthGuard: セッション発行
    end

    AuthGuard->>DB: プロフィール確認
    
    alt 未登録 or 不完全
        AuthGuard->>Browser: /onboarding へリダイレクト
    end
    
    alt Email ポリシー違反
        AuthGuard->>Browser: ログアウト + エラー表示
    end

    AuthGuard->>Browser: ページ表示
```

### 認証ポリシー

| 条件 | 対象ドメイン | 備考 |
|------|-------------|------|
| **許可** | `edu.teu.ac.jp` | 大学メールアドレス |
| **許可** | Gmail (管理者のみ) | Administrator/Supervisor ロール保持者 |
| **拒否** | その他 | ログイン不可 |

---

## 5. ロール・権限モデル

```mermaid
graph TD
    subgraph Leaders["リーダーロール"]
        Admin["Administrator"]
        Super["Supervisor"]
        PAL["PA Leader"]
        LightL["Lighting Leader"]
        PartL["Part Leader"]
    end

    subgraph Positions["役職"]
        Official["Official"]
        President["President"]
        VP["Vice President"]
        Treasurer["Treasurer"]
        PAC["PA Chief"]
        LightC["Lighting Chief"]
        WebSec["Web Secretary"]
    end

    Admin --> |Full Access| All["全機能"]
    Super --> |Full Access| All
    PAL --> PAFeatures["PA機能"]
    LightL --> LightFeatures["照明機能"]
```

---

## 6. 主要ページマップ

```mermaid
graph LR
    subgraph Public["公開ページ"]
        Login["/login"]
        Terms["/terms"]
        Privacy["/privacy"]
    end

    subgraph General["一般ユーザー"]
        Home["/home"]
        Events["/events"]
        Bands["/bands"]
        Members["/members"]
        Me["/me"]
        Onboarding["/onboarding"]
    end

    subgraph Admin["管理者"]
        AdminTop["/admin"]
        AdminEvents["/admin/events"]
        AdminRoles["/admin/roles"]
        AdminAnnounce["/admin/announcements"]
    end

    subgraph Staff["PA/照明担当"]
        PA["/pa"]
        Lighting["/lighting"]
    end

    Login --> Onboarding
    Onboarding --> Home
    Home --> Events
    Events --> Bands
```

---

## 7. データフロー

```mermaid
flowchart LR
    subgraph Frontend
        Component["Reactコンポーネント"]
        Query["TanStack Query"]
    end

    subgraph Supabase
        Client["Supabase Client"]
        RLS["Row Level Security"]
        DB[(PostgreSQL)]
    end

    Component --> |状態取得| Query
    Query --> |データフェッチ| Client
    Client --> |クエリ実行| RLS
    RLS --> |認可チェック| DB
    DB --> |データ返却| RLS
    RLS --> Client
    Client --> Query
    Query --> |キャッシュ更新| Component
```

---

## 8. 主要コンポーネント関係

| コンポーネント | 役割 | ファイル |
|---------------|------|---------|
| `RootLayout` | アプリ全体のレイアウト | `app/layout.tsx` |
| `AuthProvider` | 認証状態の提供 | `contexts/AuthContext.tsx` |
| `AuthGuard` | 認証・認可チェック | `lib/AuthGuard.tsx` |
| `SideNav` | サイドナビゲーション | `components/SideNav.tsx` |
| `PageHeader` | ページヘッダー | `components/PageHeader.tsx` |
| `QueryProvider` | TanStack Query 設定 | `components/QueryProvider.tsx` |

---

## 9. デプロイメント構成

```mermaid
graph LR
    subgraph Developer
        Local["ローカル開発"]
        Git["GitHub"]
    end

    subgraph Vercel
        Preview["プレビュー環境"]
        Prod["本番環境"]
    end

    subgraph Supabase
        DevProject["開発プロジェクト"]
        ProdProject["本番プロジェクト"]
    end

    Local --> |push| Git
    Git --> |PR作成| Preview
    Git --> |main マージ| Prod
    Preview --> DevProject
    Prod --> ProdProject
```

---

## 10. セキュリティ対策

| 対策 | 実装 |
|------|------|
| **認証** | Supabase Auth + Google OAuth |
| **認可** | AuthGuard + RLS (Row Level Security) |
| **ドメイン制限** | `edu.teu.ac.jp` のみ許可 |
| **データ保護** | 学籍番号は `profile_private` テーブルに分離 |
| **セッション管理** | Supabase セッション (JWT) |

---

## 参考リンク

- [Next.js Documentation](https://nextjs.org/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)
- [TanStack Query Documentation](https://tanstack.com/query/latest)
